<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>First Avenue Historical Calendars Gallery</title>
    <script src="https://unpkg.com/tesseract.js@v5.0.0/dist/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #6b7280;
            min-height: 100vh;
            color: #333;
        }


        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            color: #4a5568;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #718096;
            font-size: 1.1rem;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .upload-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #4a5568;
        }

        input, select, textarea {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            width: 100%;
            height: 120px;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f7fafc;
        }

        .file-input:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .file-input input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            border: none;
            padding: 0;
        }

        .file-input-text {
            text-align: center;
            color: #718096;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
        }

        .upload-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }

        .calendar-item {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
            position: relative;
        }

        .calendar-item:hover {
            transform: translateY(-5px);
        }

        .calendar-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            background: #f7fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #a0aec0;
            font-size: 3rem;
        }

        .calendar-info {
            padding: 20px;
        }

        .calendar-date {
            font-size: 1.2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
        }

        .calendar-venue {
            font-size: 1rem;
            color: #e53e3e;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .calendar-description {
            color: #718096;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 15px;
        }

        .calendar-bands {
            color: #4a5568;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 15px;
            background: #f7fafc;
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .calendar-meta {
            font-size: 0.8rem;
            color: #a0aec0;
            border-top: 1px solid #e2e8f0;
            padding-top: 10px;
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(229, 62, 62, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .calendar-item:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn:hover {
            background: rgba(229, 62, 62, 1);
            transform: scale(1.1);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .upload-form {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .gallery {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìÖ First Avenue Historical Calendars Gallery</h1>
            <p class="subtitle">Upload and browse First Avenue calendar images in chronological order</p>
        </header>

        <div class="upload-section">
            <form class="upload-form" id="uploadForm">
                <div class="form-group full-width">
                    <label for="imageFile">Calendar Image</label>
                    <div class="file-input-wrapper">
                        <div class="file-input">
                            <input type="file" id="imageFile" accept="image/*" required>
                            <div class="file-input-text">
                                <div style="font-size: 2rem; margin-bottom: 10px;">üìÅ</div>
                                <div>Click to select calendar image</div>
                                <div style="font-size: 0.8rem; margin-top: 5px;">JPG, PNG, GIF up to 10MB</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group full-width">
                    <label for="calendarDate">Date</label>
                    <input type="date" id="calendarDate" required>
                </div>

                <div class="form-group full-width">
                    <label for="description">Description (Optional)</label>
                    <textarea id="description" rows="3" placeholder="Add any notes about this calendar..."></textarea>
                </div>

                <div class="form-group full-width" id="bandsSection" style="display: none;">
                    <label for="bands">Detected Bands/Artists</label>
                    <div id="ocrStatus" style="margin-bottom: 10px; font-size: 0.9rem; color: #667eea;"></div>
                    <textarea id="bands" rows="4" placeholder="Extracting band names from image..."></textarea>
                    <div style="font-size: 0.8rem; color: #718096; margin-top: 5px;">
                        OCR detected text - you can edit this list before uploading
                    </div>
                </div>

                <div class="form-group">
                    <button type="submit" class="upload-btn">Upload Calendar</button>
                </div>
            </form>
        </div>

        <div class="search-section" id="searchSection">
            <div style="background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px);">
                <label for="artistSearch" style="font-weight: 600; margin-bottom: 8px; color: #4a5568; display: block;">Search by Artist</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="artistSearch" placeholder="Enter artist or band name..." style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                    <button onclick="calendarGallery.clearSearch()" style="background: #e2e8f0; color: #4a5568; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer;">Clear</button>
                </div>
                <div id="searchResults" style="margin-top: 10px; font-size: 0.9rem; color: #667eea;"></div>
            </div>
        </div>

        <div class="gallery" id="gallery">
            <div class="empty-state">
                <div class="empty-state-icon">üìÖ</div>
                <h3>No calendar images yet</h3>
                <p>Upload your first calendar image to get started!</p>
            </div>
        </div>
    </div>

    <script>
        class CalendarGallery {
            constructor() {
                this.calendars = this.loadCalendars();
                this.filteredCalendars = this.calendars;
                this.initializeEventListeners();
                this.renderGallery();
            }

            loadCalendars() {
                const stored = localStorage.getItem('calendarImages');
                return stored ? JSON.parse(stored) : [];
            }

            saveCalendars() {
                localStorage.setItem('calendarImages', JSON.stringify(this.calendars));
            }

            initializeEventListeners() {
                const form = document.getElementById('uploadForm');
                const fileInput = document.getElementById('imageFile');
                const searchInput = document.getElementById('artistSearch');
                
                form.addEventListener('submit', (e) => this.handleUpload(e));
                
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const fileInputText = document.querySelector('.file-input-text');
                        fileInputText.innerHTML = `
                            <div style="font-size: 2rem; margin-bottom: 10px;">‚úÖ</div>
                            <div><strong>${file.name}</strong></div>
                            <div style="font-size: 0.8rem; margin-top: 5px;">${this.formatFileSize(file.size)}</div>
                        `;
                        
                        // Auto-extract date from filename
                        this.extractDateFromFilename(file.name);
                        
                        // Start OCR text recognition
                        this.performOCR(file);
                    }
                });

                // Search functionality
                searchInput.addEventListener('input', (e) => {
                    this.searchArtists(e.target.value);
                });
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            async performOCR(file) {
                const bandsSection = document.getElementById('bandsSection');
                const ocrStatus = document.getElementById('ocrStatus');
                const bandsTextarea = document.getElementById('bands');
                
                // Show the bands section
                bandsSection.style.display = 'block';
                ocrStatus.textContent = 'üîç Analyzing image for text...';
                bandsTextarea.value = '';
                
                try {
                    const { data: { text } } = await Tesseract.recognize(file, 'eng', {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                const progress = Math.round(m.progress * 100);
                                ocrStatus.textContent = `üîç Reading text... ${progress}%`;
                            }
                        }
                    });
                    
                    // Extract potential band names from the OCR text
                    const extractedBands = this.extractBandNames(text);
                    
                    if (extractedBands.length > 0) {
                        bandsTextarea.value = extractedBands.join('\n');
                        ocrStatus.textContent = `‚úÖ Found ${extractedBands.length} potential band/artist names`;
                        ocrStatus.style.color = '#38a169';
                    } else {
                        bandsTextarea.value = text.trim();
                        ocrStatus.textContent = '‚ö†Ô∏è No clear band names detected - showing all text';
                        ocrStatus.style.color = '#d69e2e';
                    }
                    
                } catch (error) {
                    console.error('OCR Error:', error);
                    ocrStatus.textContent = '‚ùå Text recognition failed';
                    ocrStatus.style.color = '#e53e3e';
                    bandsTextarea.placeholder = 'OCR failed - you can manually enter band names here';
                }
            }

            extractBandNames(text) {
                // Clean up the text
                const lines = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);
                
                const bandNames = [];
                const commonWords = ['the', 'and', 'with', 'plus', 'featuring', 'feat', 'presents', 'live', 'concert', 'show', 'tour', 'tickets', 'doors', 'pm', 'am', 'all', 'ages', '$', 'price', 'advance', 'day', 'show', 'mpls', 'first', 'avenue', '7th', 'entry', 'st', 'firstavenue'];
                const daysOfWeek = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                const venues = ['first avenue', '7th st entry', 'palace theatre', 'fine line', 'turf club'];
                
                for (let line of lines) {
                    // Skip lines that contain any numbers
                    if (/\d/.test(line)) continue;
                    
                    // Skip very short lines
                    if (line.length < 3) continue;
                    
                    // Skip venue names
                    if (venues.some(venue => line.toLowerCase().includes(venue))) continue;
                    
                    // Skip days of the week
                    if (daysOfWeek.some(day => line.toLowerCase().includes(day))) continue;
                    
                    // Clean the line
                    let cleanLine = line
                        .replace(/[^\w\s&]/g, ' ') // Remove special chars except &
                        .replace(/\d/g, ' ')       // Remove all numbers
                        .replace(/\s+/g, ' ')      // Normalize spaces
                        .trim();
                    
                    // Skip if it's mostly common words
                    const words = cleanLine.toLowerCase().split(' ');
                    const nonCommonWords = words.filter(word => !commonWords.includes(word) && !daysOfWeek.includes(word));
                    
                    // Also check if the entire line contains venue-related terms
                    const lowerLine = cleanLine.toLowerCase();
                    const hasVenueTerms = venues.some(venue => lowerLine.includes(venue)) || 
                                         lowerLine.includes('mpls') || 
                                         lowerLine.includes('7th') || 
                                         lowerLine.includes('entry') ||
                                         lowerLine.includes('first avenue') ||
                                         lowerLine.includes('firstavenue');
                    
                    if (nonCommonWords.length > 0 && cleanLine.length > 2 && !hasVenueTerms) {
                        // Capitalize properly
                        const formatted = cleanLine
                            .split(' ')
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                            .join(' ');
                        
                        if (!bandNames.includes(formatted)) {
                            bandNames.push(formatted);
                        }
                    }
                }
                
                return bandNames.slice(0, 20); // Limit to 20 entries
            }

            extractDateFromFilename(filename) {
                const dateInput = document.getElementById('calendarDate');
                
                // Remove file extension
                const nameWithoutExt = filename.replace(/\.[^/.]+$/, "");
                
                // Common date patterns in filenames
                const datePatterns = [
                    // YYYY-MM-DD or YYYY_MM_DD or YYYY.MM.DD
                    /(\d{4})[-_.](\d{1,2})[-_.](\d{1,2})/,
                    // MM-DD-YYYY or MM_DD_YYYY or MM.DD.YYYY
                    /(\d{1,2})[-_.](\d{1,2})[-_.](\d{4})/,
                    // YYYYMMDD
                    /(\d{4})(\d{2})(\d{2})/,
                    // Month names with year (e.g., "January 2024", "Jan_2024")
                    /(january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[-_\s]*(\d{4})/i,
                    // Year only (e.g., "2024")
                    /(\d{4})/
                ];

                for (let pattern of datePatterns) {
                    const match = nameWithoutExt.match(pattern);
                    if (match) {
                        let date = null;
                        
                        if (pattern === datePatterns[0]) {
                            // YYYY-MM-DD format
                            const [, year, month, day] = match;
                            date = new Date(year, month - 1, day);
                        } else if (pattern === datePatterns[1]) {
                            // MM-DD-YYYY format
                            const [, month, day, year] = match;
                            date = new Date(year, month - 1, day);
                        } else if (pattern === datePatterns[2]) {
                            // YYYYMMDD format
                            const [, year, month, day] = match;
                            date = new Date(year, month - 1, day);
                        } else if (pattern === datePatterns[3]) {
                            // Month name with year
                            const [, monthName, year] = match;
                            const monthMap = {
                                'january': 0, 'jan': 0, 'february': 1, 'feb': 1, 'march': 2, 'mar': 2,
                                'april': 3, 'apr': 3, 'may': 4, 'june': 5, 'jun': 5,
                                'july': 6, 'jul': 6, 'august': 7, 'aug': 7, 'september': 8, 'sep': 8,
                                'october': 9, 'oct': 9, 'november': 10, 'nov': 10, 'december': 11, 'dec': 11
                            };
                            const month = monthMap[monthName.toLowerCase()];
                            if (month !== undefined) {
                                date = new Date(year, month, 1);
                            }
                        } else if (pattern === datePatterns[4]) {
                            // Year only - use January 1st of that year
                            const [, year] = match;
                            date = new Date(year, 0, 1);
                        }
                        
                        if (date && !isNaN(date.getTime())) {
                            // Format date as YYYY-MM-DD for the input field
                            const formattedDate = date.toISOString().split('T')[0];
                            dateInput.value = formattedDate;
                            
                            // Visual feedback
                            dateInput.style.backgroundColor = '#e6fffa';
                            setTimeout(() => {
                                dateInput.style.backgroundColor = '';
                            }, 1000);
                            
                            break;
                        }
                    }
                }
            }

            handleUpload(e) {
                e.preventDefault();
                
                const fileInput = document.getElementById('imageFile');
                const dateInput = document.getElementById('calendarDate');
                const descriptionInput = document.getElementById('description');
                const bandsInput = document.getElementById('bands');
                
                const file = fileInput.files[0];
                if (!file) return;

                // Create FileReader to convert image to base64
                const reader = new FileReader();
                reader.onload = (e) => {
                    const calendar = {
                        id: Date.now(),
                        imageData: e.target.result,
                        date: dateInput.value,
                        venue: 'First Avenue', // Default venue
                        description: descriptionInput.value,
                        bands: bandsInput.value,
                        fileName: file.name,
                        fileSize: file.size,
                        uploadDate: new Date().toISOString()
                    };

                    this.calendars.push(calendar);
                    this.filteredCalendars = this.calendars;
                    this.saveCalendars();
                    this.renderGallery();
                    this.updateSearchSection();
                    
                    // Reset form
                    document.getElementById('uploadForm').reset();
                    document.querySelector('.file-input-text').innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 10px;">üìÅ</div>
                        <div>Click to select calendar image</div>
                        <div style="font-size: 0.8rem; margin-top: 5px;">JPG, PNG, GIF up to 10MB</div>
                    `;
                    
                    // Hide bands section after upload
                    document.getElementById('bandsSection').style.display = 'none';
                };
                
                reader.readAsDataURL(file);
            }

            searchArtists(searchTerm) {
                const searchResults = document.getElementById('searchResults');
                
                if (!searchTerm.trim()) {
                    this.filteredCalendars = this.calendars;
                    searchResults.textContent = '';
                } else {
                    this.filteredCalendars = this.calendars.filter(calendar => {
                        if (!calendar.bands) return false;
                        return calendar.bands.toLowerCase().includes(searchTerm.toLowerCase());
                    });
                    
                    const count = this.filteredCalendars.length;
                    searchResults.textContent = count > 0 ? 
                        `Found ${count} calendar${count === 1 ? '' : 's'} with "${searchTerm}"` :
                        `No calendars found with "${searchTerm}"`;
                }
                
                this.renderGallery();
            }

            clearSearch() {
                document.getElementById('artistSearch').value = '';
                document.getElementById('searchResults').textContent = '';
                this.filteredCalendars = this.calendars;
                this.renderGallery();
            }

            updateSearchSection() {
                const searchSection = document.getElementById('searchSection');
                searchSection.style.display = 'block'; // Always show search section
            }

            renderGallery() {
                const gallery = document.getElementById('gallery');
                
                if (this.calendars.length === 0) {
                    gallery.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìÖ</div>
                            <h3>No calendar images yet</h3>
                            <p>Upload your first calendar image to get started!</p>
                        </div>
                    `;
                    return;
                }

                if (this.filteredCalendars.length === 0) {
                    gallery.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üîç</div>
                            <h3>No matching calendars found</h3>
                            <p>Try a different search term or clear the search.</p>
                        </div>
                    `;
                    return;
                }

                // Sort calendars chronologically (newest first)
                const sortedCalendars = [...this.filteredCalendars].sort((a, b) => new Date(b.date) - new Date(a.date));

                gallery.innerHTML = sortedCalendars.map(calendar => `
                    <div class="calendar-item">
                        <button class="delete-btn" onclick="calendarGallery.deleteCalendar(${calendar.id})" title="Delete calendar">√ó</button>
                        <img src="${calendar.imageData}" alt="${calendar.fileName}" class="calendar-image">
                        <div class="calendar-info">
                            <div class="calendar-date">${this.formatDate(calendar.date)}</div>
                            <div class="calendar-venue">${calendar.venue}</div>
                            ${calendar.description ? `<div class="calendar-description">${calendar.description}</div>` : ''}
                            ${calendar.bands ? `<div class="calendar-bands"><strong>Possible Artists:</strong><br>${calendar.bands.split('\n').join(', ')}</div>` : ''}
                            <div class="calendar-meta">
                                Uploaded: ${this.formatDate(calendar.uploadDate.split('T')[0])} ‚Ä¢ ${this.formatFileSize(calendar.fileSize)}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            deleteCalendar(id) {
                const password = prompt('Enter password to delete this calendar:');
                if (password !== 'prince') {
                    alert('Incorrect password. Calendar not deleted.');
                    return;
                }
                
                const confirmDelete = confirm('Are you sure you want to delete this calendar? This action cannot be undone.');
                if (!confirmDelete) {
                    return;
                }
                
                // Remove calendar from array
                this.calendars = this.calendars.filter(calendar => calendar.id !== id);
                this.filteredCalendars = this.calendars;
                this.saveCalendars();
                this.renderGallery();
                this.updateSearchSection();
                
                // Show success message
                alert('Calendar deleted successfully.');
            }

            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
        }

        // Initialize the gallery when the page loads
        let calendarGallery;
        document.addEventListener('DOMContentLoaded', () => {
            calendarGallery = new CalendarGallery();
        });
    </script>
</body>
</html>
